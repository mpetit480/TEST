<?xml version="1.0" encoding="UTF-8"?>
<jobs>
   <metadata>
      <row>
         <version>21.0.0</version>
      </row>
   </metadata>
   <general_attributes>
      <row>
         <minimum_ae_version>11.2</minimum_ae_version>
         <auto_deactivation>A</auto_deactivation>
         <child_flags>00000000000000000000000000000000</child_flags>
         <ert>1</ert>
         <platform>WINDOWS</platform>
         <last_runtimes>AQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAAAAAA==</last_runtimes>
         <max_parallel_action>1</max_parallel_action>
         <mrt_time>000000</mrt_time>
         <name>JOBS.APPROVE.ENV_PROV.ADD.MAIL</name>
         <type>JOBS</type>
         <inherit_output_filter>N</inherit_output_filter>
         <queue>CLIENT_QUEUE</queue>
         <versioning_id>1640823165</versioning_id>
      </row>
   </general_attributes>
   <scripts>
      <row>
         <process><![CDATA[
:SET &SUBJECT#="ASO: APPROBATION provisioning de &NUMBER_CLIENT# VM pour &ENTITE_KISS#"
:SET &NL# = UC_CRLF()
!----- 3 jours ---------------
!:SET &TIMEOUT#=86400*&MAX_MAIL#
:SET &TIMEOUT#=120
!-----------------------------
:SET &COMPTEUR_TEMPS#=0
:SET &CHECK_STATUS_TIMER#=20
:SET &COMPTEUR_MAIL#=0

:P DEBUG1 &RECEIVER#
:SET &SORTIE#=0

:SET  &FORMAT# = 'WW'

:PSET &ALIAS#=STR_CAT("CALL.APPROVE.ENV_PROV.ADD.",&$TOP_PROCESSFLOW_RUNID#)
:SET &CALL_RUN_ID# = ACTIVATE_UC_OBJECT(CALL.APPROVE.ENV_PROV.ADD.STANDARD,,,,,PASS_VALUES,,&ALIAS#)

:WHILE &SORTIE# < 1


:  SET  &WEEKDAY# = SYS_DATE_PHYSICAL(&FORMAT#)
! on n'envoie le mail que si le reste de la division est 0, cad 1 jour ou 86400 secondes
!:  SET &rest# = MOD(&COMPTEUR_TEMPS#,86400)
:  SET &rest# = MOD(&COMPTEUR_TEMPS#,60)
:  P DEBUG MOD &rest#
!------------------------------------
:  IF &rest# = 0
:    IF &WEEKDAY# = "SA"
:      SET &TIMEOUT#=&TIMEOUT# - 86400
:    ENDIF
:    IF &WEEKDAY# = "SO"
:      SET &TIMEOUT#=&TIMEOUT# - 86400
:    ENDIF
:    IF &WEEKDAY# <> "SA"
:      IF &WEEKDAY# <> "SO"
:        IF &COMPTEUR_MAIL# < &MAX_MAIL#
:         SET &COMPTEUR_MAIL#=&COMPTEUR_MAIL#+1
:         SET &X#=FORMAT(&COMPTEUR_MAIL#,"0")
:         SET &Y#=FORMAT(&MAX_MAIL#,"0")
:         SET &TEXTE#="Bonjour,&NL#&NL#Vous avez une approbation en attente sur ASO.&NL#Connectez vous Ã  AWI, client &$CLIENT# pour approuver ou rejeter le CALL &ALIAS# pour le metaflow &$TOP_PROCESSFLOW_NAME# runId &$TOP_PROCESSFLOW_RUNID#.&NL#Mail &X# sur &Y#.&NL#&NL#Cordialement"
:         SET &RET#=SEND_MAIL(&RECEIVER#,, &SUBJECT#, &TEXTE#)
:       ENDIF
:      ENDIF
:    ENDIF
:  ENDIF
:  SET &STATUS# = GET_UC_OBJECT_STATUS(CALL,&CALL_RUN_ID#)
:  WAIT &CHECK_STATUS_TIMER#
:  SET &COMPTEUR_TEMPS#=&COMPTEUR_TEMPS# + &CHECK_STATUS_TIMER#

:  PRINT "The status of &CALL_RUN_ID# is &STATUS#"
:  SWITCH "Y"
:    CASE &STATUS# between 1900 and 1999
:        P Job ended with ANY_OK
:        SET &SORTIE#=2
:    CASE &STATUS# between 1800 and 1899
:        SET &ST# = CANCEL_UC_OBJECT(&$RUNID#)
:        P Job ended with ANY_ABEND CANCEL du JOB car CALL non approuve
!:        MODIFY_STATE RETCODE=99
:  ENDSWITCH
:  IF &COMPTEUR_TEMPS# = &TIMEOUT#
:    SET &ST# = CANCEL_UC_OBJECT(&CALL_RUN_ID#)
:    P DEBUG CANCEL du CALL car TIMEOUT
:    SET &ST# = CANCEL_UC_OBJECT(&$RUNID#)
:    P DEBUG CANCEL du JOBS WINDOWS car TIMEOUT
!:    MODIFY_STATE RETCODE=99
:  ENDIF
:ENDWHILE]]></process>
      </row>
   </scripts>
   <job_attributes>
      <row>
         <activation_at_runtime>1</activation_at_runtime>
         <platform>WINDOWS</platform>
         <agent>WIN01</agent>
         <login>LOGIN.WIN01</login>
         <job_report_path>2</job_report_path>
         <win_work_dir>c:\</win_work_dir>
         <win_typ>0</win_typ>
         <win_view>0</win_view>
         <win_logon_as_batch>0</win_logon_as_batch>
         <win_show_at_desktop>0</win_show_at_desktop>
         <win_report_by_script>0</win_report_by_script>
         <job_object></job_object>
         <win_cmd></win_cmd>
      </row>
   </job_attributes>
   <rollback_definitions>
      <row>
      </row>
   </rollback_definitions>
</jobs>
